<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DANHS School Grades</title>
<style>
body { font-family: Arial; padding: 20px; }
input, select, button { display: block; margin: 5px 0; padding: 8px; }
table, th, td { border: 1px solid black; border-collapse: collapse; padding: 5px; }
table { margin-top: 10px; width: 100%; }
#adminPanel, #gradesContainer, #logoutBtn { display:none; }
.strength { font-size: 12px; color: red; }
</style>
</head>
<body>

<h1>DANHS School Grades</h1>

<!-- Signup Form -->
<div id="signupDiv">
  <h2>Signup</h2>
  <input type="email" id="signupEmail" placeholder="Email">
  <input type="password" id="signupPassword" placeholder="Password">
  <button type="button" id="togglePassword">Show Password</button>
  <div class="strength" id="passwordStrength">Password strength: </div>
  <button onclick="signup()">Sign Up</button>
</div>

<!-- Login Form -->
<div id="loginDiv">
  <h2>Login</h2>
  <input type="email" id="loginEmail" placeholder="Email">
  <input type="password" id="loginPassword" placeholder="Password">
  <button type="button" id="toggleLoginPassword">Show Password</button>
  <button onclick="login()">Login</button>
</div>

<!-- Logout Button -->
<button id="logoutBtn">Logout</button>

<hr>

<!-- Main Content -->
<div id="mainContent">

  <!-- Admin Panel -->
  <div id="adminPanel">
    <h2>Admin Panel</h2>
    
    <!-- Users Table -->
    <h3>All Users</h3>
    <table id="usersTable">
      <thead>
        <tr>
          <th>Name</th><th>Email</th><th>Number</th><th>Purok</th>
          <th>Guardian</th><th>Guardian Phone</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Add/Edit Grades -->
    <h3>Edit/Add Grades</h3>
    <input type="text" id="studentName" placeholder="Student Name">
    <select id="studentLevel">
      <option value="">Select Level</option>
      <option value="7">7</option><option value="8">8</option>
      <option value="9">9</option><option value="10">10</option>
      <option value="11">11</option><option value="12">12</option>
    </select>
    <select id="studentSection">
      <option value="">Select Section</option>
      <option value="A">A</option><option value="B">B</option>
      <option value="C">C</option><option value="D">D</option>
    </select>
    <input type="text" id="studentSubject" placeholder="Subject">
    <input type="number" id="studentGrade" placeholder="Grade">
    <button onclick="addOrUpdateGrade()">Add / Update Grade</button>
  </div>

  <!-- Grades Table for Students -->
  <div id="gradesContainer">
    <h2>Grades</h2>
    <table id="gradesTable">
      <thead>
        <tr>
          <th>Student</th><th>Level</th><th>Section</th><th>Subject</th><th>Grade</th><th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Profile Settings -->
  <div id="profileSettings" style="display:none;">
    <h2>My Information</h2>
    <input type="text" id="profileName" placeholder="Full Name">
    <input type="text" id="profileNumber" placeholder="Mobile Number">
    <input type="text" id="profilePurok" placeholder="Purok">
    <input type="text" id="profileGuardian" placeholder="Parent/Guardian Name">
    <input type="text" id="profileGuardianPhone" placeholder="Parent/Guardian Phone">
    <button onclick="saveProfile()">Save Information</button>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, query, where, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCYPONQgJC33Lp2OmMyKw4hssDStEwvPlQ",
  authDomain: "test-9c727.firebaseapp.com",
  projectId: "test-9c727",
  storageBucket: "test-9c727.firebasestorage.app",
  messagingSenderId: "198578631587",
  appId: "1:198578631587:web:c0831122f964d46149e016"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- Signup ---
window.signup = async ()=>{
  const email = document.getElementById("signupEmail").value;
  const password = document.getElementById("signupPassword").value;
  if(password.length < 6){ alert("Password too short"); return; }
  try{
    const userCred = await createUserWithEmailAndPassword(auth,email,password);
    await setDoc(doc(db,"users",userCred.user.uid),{
      email,
      level:"7",
      section:"A",
      name:"",
      mobile:"",
      purok:"",
      guardian:"",
      guardianPhone:""
    });
    alert("Signup successful!");
  }catch(err){ alert("Error: "+err.message); }
}

// --- Login ---
window.login = async ()=>{
  const email = document.getElementById("loginEmail").value;
  const password = document.getElementById("loginPassword").value;
  try{
    await signInWithEmailAndPassword(auth,email,password);
  }catch(err){ alert("Error: "+err.message); }
}

// --- Logout ---
document.getElementById("logoutBtn").addEventListener("click", async ()=>{
  await signOut(auth);
  location.reload();
});

// --- Auth State ---
onAuthStateChanged(auth, async (user)=>{
  if(user){
    document.getElementById("signupDiv").style.display="none";
    document.getElementById("loginDiv").style.display="none";
    document.getElementById("logoutBtn").style.display="block";
    document.getElementById("mainContent").style.display="block";
    document.getElementById("profileSettings").style.display="block";
    checkAdmin(user.uid);
  }else{
    document.getElementById("signupDiv").style.display="block";
    document.getElementById("loginDiv").style.display="block";
    document.getElementById("logoutBtn").style.display="none";
    document.getElementById("mainContent").style.display="none";
  }
});

// --- Check Admin ---
async function checkAdmin(uid){
  const docu = await getDocs(query(collection(db,"users"), where("__name__","==",uid)));
  docu.forEach(async snap=>{
    const data = snap.data();
    if(data.level==="admin"){
      document.getElementById("adminPanel").style.display="block";
      loadUsers();
      loadGradesAll();
    } else {
      loadGrades(data.level,data.section);
    }
    loadProfile(uid,data);
  });
}

// --- Load Users ---
async function loadUsers(){
  const tbody = document.querySelector("#usersTable tbody");
  tbody.innerHTML="";
  const snapshot = await getDocs(collection(db,"users"));
  snapshot.forEach(d=>{
    const data = d.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${data.name||""}</td>
      <td>${data.email}</td>
      <td>${data.mobile||""}</td>
      <td>${data.purok||""}</td>
      <td>${data.guardian||""}</td>
      <td>${data.guardianPhone||""}</td>
      <td><button onclick="makeAdmin('${d.id}')">Make Admin</button></td>`;
    tbody.appendChild(tr);
  });
}

// --- Make Admin ---
window.makeAdmin = async (id)=>{
  await updateDoc(doc(db,"users",id), { level: "admin" });
  alert("User promoted to Admin!");
  loadUsers();
}

// --- Load Grades ---
async function loadGradesAll(){
  document.getElementById("gradesContainer").style.display="block";
  const tbody = document.querySelector("#gradesTable tbody");
  tbody.innerHTML="";
  const snapshot = await getDocs(collection(db,"grades"));
  snapshot.forEach(doc=>{
    const d=doc.data();
    const tr = document.createElement("tr");
    tr.innerHTML=`
      <td>${d.student}</td><td>${d.level}</td><td>${d.section}</td><td>${d.subject}</td><td>${d.grade}</td>
      <td><button onclick="deleteGrade('${doc.id}')">Delete</button></td>`;
    tbody.appendChild(tr);
  });
}

async function loadGrades(level,section){
  document.getElementById("gradesContainer").style.display="block";
  const tbody = document.querySelector("#gradesTable tbody");
  tbody.innerHTML="";
  const q = query(collection(db,"grades"),where("level","==",level),where("section","==",section));
  const snapshot = await getDocs(q);
  snapshot.forEach(doc=>{
    const d=doc.data();
    const tr = document.createElement("tr");
    tr.innerHTML=`<td>${d.student}</td><td>${d.level}</td><td>${d.section}</td><td>${d.subject}</td><td>${d.grade}</td>`;
    tbody.appendChild(tr);
  });
}

// --- Add/Update Grade ---
window.addOrUpdateGrade = async ()=>{
  const name = document.getElementById("studentName").value;
  const level = document.getElementById("studentLevel").value;
  const section = document.getElementById("studentSection").value;
  const subject = document.getElementById("studentSubject").value;
  const grade = document.getElementById("studentGrade").value;
  const q = query(collection(db,"grades"), where("student","==",name), where("subject","==",subject), where("level","==",level), where("section","==",section));
  const snapshot = await getDocs(q);
  if(!snapshot.empty){
    snapshot.forEach(async docu=>{
      await updateDoc(doc(db,"grades",docu.id),{grade});
    });
    alert("Grade updated!");
  } else {
    await addDoc(collection(db,"grades"),{student:name,level,section,subject,grade});
    alert("Grade added!");
  }
  loadGradesAll();
}

// --- Delete Grade ---
window.deleteGrade = async (id)=>{
  await deleteDoc(doc(db,"grades",id));
  alert("Grade deleted!");
  loadGradesAll();
}

// --- Profile ---
function loadProfile(uid,data){
  document.getElementById("profileName").value = data.name||"";
  document.getElementById("profileNumber").value = data.mobile||"";
  document.getElementById("profilePurok").value = data.purok||"";
  document.getElementById("profileGuardian").value = data.guardian||"";
  document.getElementById("profileGuardianPhone").value = data.guardianPhone||"";
}

window.saveProfile = async ()=>{
  const user = auth.currentUser;
  if(!user) return;
  await updateDoc(doc(db,"users",user.uid),{
    name: document.getElementById("profileName").value,
    mobile: document.getElementById("profileNumber").value,
    purok: document.getElementById("profilePurok").value,
    guardian: document.getElementById("profileGuardian").value,
    guardianPhone: document.getElementById("profileGuardianPhone").value
  });
  alert("Profile updated!");
}
</script>
</body>
                            </html>
