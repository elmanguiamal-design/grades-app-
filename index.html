<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DANHS School Grades</title>
<style>
/* --- GENERAL STYLES --- */
body { font-family: Arial, sans-serif; margin:0; padding:0; background-color:#f0f2f5; }
h1,h2,h3 { margin:10px 0; }
button { cursor:pointer; padding:6px 12px; border:none; border-radius:4px; }
input, select, button { display:block; margin:5px 0; padding:8px; width:100%; box-sizing:border-box; }
table { border-collapse: collapse; width: 100%; margin-top: 10px; }
th, td { border: 1px solid #333; padding: 5px; text-align:center; }

/* --- HAMBURGER MENU --- */
#hamburgerIcon { position:fixed; top:10px; right:10px; font-size:30px; cursor:pointer; display:none; z-index:1001; }
#sideMenu { position:fixed; top:0; left:-250px; width:250px; height:100%; background-color:#333; color:white; overflow-y:auto; padding:20px; transition:0.3s; z-index:1000; }
#sideMenu h2, #sideMenu h3 { color:white; }

/* --- PANELS --- */
#signupDiv, #loginDiv { max-width:400px; margin:50px auto; padding:20px; background:white; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.2); }
#gradesContainer, #adminPanel, #memberInfoContainer { display:none; max-width:900px; margin:20px auto; background:white; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.2); }

/* --- PASSWORD STRENGTH --- */
.strength { font-size:12px; color:red; }

/* --- TABLE SCROLL --- */
.tableWrapper { max-height:300px; overflow-y:auto; }

/* --- PASS/FAIL COLORS --- */
.passed { color:green; font-weight:bold; }
.failed { color:red; font-weight:bold; }

/* --- RESPONSIVE --- */
@media screen and (max-width:600px){
  #signupDiv, #loginDiv, #gradesContainer, #adminPanel, #memberInfoContainer { width:90%; }
  #sideMenu { width:200px; }
}
</style>
</head>
<body>

<!-- --- HAMBURGER ICON --- -->
<div id="hamburgerIcon">&#9776;</div>

<!-- --- SIDE MENU --- -->
<div id="sideMenu">
  <h2>Menu</h2>
  <button onclick="showPanel('gradesContainer')">Grades</button>
  <button onclick="showPanel('memberInfoContainer')">My Information</button>
  <button id="adminPanelButton" onclick="showPanel('adminPanel')">Admin Panel</button>
  <button id="logoutBtn" style="display:block;">Logout</button>
</div>

<h1>DANHS School Grades</h1>

<!-- --- SIGNUP --- -->
<div id="signupDiv">
  <h2>Signup</h2>
  <input type="email" id="signupEmail" placeholder="Email">
  <input type="password" id="signupPassword" placeholder="Password">
  <button type="button" id="togglePassword">Show Password</button>
  <div class="strength" id="passwordStrength">Password strength:</div>
  <button onclick="signup()">Sign Up</button>
  <p>Already have an account? <span style="color:blue;cursor:pointer;" onclick="showLogin()">Login</span></p>
</div>

<!-- --- LOGIN --- -->
<div id="loginDiv">
  <h2>Login</h2>
  <input type="email" id="loginEmail" placeholder="Email">
  <input type="password" id="loginPassword" placeholder="Password">
  <button type="button" id="toggleLoginPassword">Show Password</button>
  <button onclick="login()">Login</button>
  <p>Don't have an account? <span style="color:blue;cursor:pointer;" onclick="showSignup()">Sign Up</span></p>
</div>

<!-- --- GRADES TABLE --- -->
<div id="gradesContainer">
  <h2>Grades</h2>
  <div class="tableWrapper">
    <table id="gradesTable">
      <thead>
        <tr>
          <th>Student</th>
          <th>Level</th>
          <th>Section</th>
          <th>Subject</th>
          <th>Grade</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- --- MEMBER INFORMATION --- -->
<div id="memberInfoContainer"></div>

<!-- --- ADMIN PANEL --- -->
<div id="adminPanel">
  <h2>Admin Panel</h2>
  <h3>All Users</h3>
  <input type="text" id="userSearch" placeholder="Search users...">
  <div class="tableWrapper">
    <table id="usersTable">
      <thead>
        <tr>
          <th>Email</th>
          <th>Level</th>
          <th>Section</th>
          <th>Edit Section</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <h3>Edit/Add Grades</h3>
  <input type="text" id="studentName" placeholder="Student Name">
  <select id="studentLevel">
    <option value="">Select Level</option>
    <option value="7">7</option><option value="8">8</option>
    <option value="9">9</option><option value="10">10</option>
    <option value="11">11</option><option value="12">12</option>
  </select>
  <select id="studentSection">
    <option value="">Select Section</option>
    <option value="A">A</option><option value="B">B</option>
    <option value="C">C</option><option value="D">D</option>
  </select>
  <input type="text" id="studentSubject" placeholder="Subject">
  <input type="number" id="studentGrade" placeholder="Grade">
  <button onclick="addOrUpdateGrade()">Add / Update Grade</button>

  <h3>Create New Admin</h3>
  <input type="email" id="newAdminEmail" placeholder="Admin Email">
  <input type="password" id="newAdminPassword" placeholder="Password">
  <button type="button" id="toggleNewAdminPassword">Show Password</button>
  <div class="strength" id="newAdminStrength">Password strength:</div>
  <button onclick="createAdmin()">Create Admin</button>
    </div>

  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, query, where, deleteDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

// --- FIREBASE CONFIG ---
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
  appId: "YOUR_APP_ID"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- SHOW/HIDE LOGIN & SIGNUP ---
function showLogin() {
  document.getElementById("signupDiv").style.display="none";
  document.getElementById("loginDiv").style.display="block";
}
function showSignup() {
  document.getElementById("signupDiv").style.display="block";
  document.getElementById("loginDiv").style.display="none";
}

// --- PASSWORD TOGGLE ---
document.getElementById("togglePassword").addEventListener("click", ()=>{
  const p = document.getElementById("signupPassword");
  p.type = p.type==="password"?"text":"password";
});
document.getElementById("toggleLoginPassword").addEventListener("click", ()=>{
  const p = document.getElementById("loginPassword");
  p.type = p.type==="password"?"text":"password";
});
document.getElementById("toggleNewAdminPassword").addEventListener("click", ()=>{
  const p = document.getElementById("newAdminPassword");
  p.type = p.type==="password"?"text":"password";
});

// --- PASSWORD STRENGTH ---
document.getElementById("signupPassword").addEventListener("input", ()=>{
  const s = document.getElementById("signupPassword").value;
  document.getElementById("passwordStrength").innerText = s.length>=6?"Password strength: Strong":"Password strength: Weak";
});
document.getElementById("newAdminPassword").addEventListener("input", ()=>{
  const s = document.getElementById("newAdminPassword").value;
  document.getElementById("newAdminStrength").innerText = s.length>=6?"Password strength: Strong":"Password strength: Weak";
});

// --- SIGNUP ---
window.signup = async ()=>{
  const email = document.getElementById("signupEmail").value;
  const password = document.getElementById("signupPassword").value;
  if(password.length<6){ alert("Password too short"); return; }
  try{
    await createUserWithEmailAndPassword(auth,email,password);
    await addDoc(collection(db,"users"),{email, level:"7", section:"A"}); // default student
    alert("Signup successful! Ask admin to update level/section.");
  }catch(err){ alert("Firebase error: "+err.message); }
}

// --- LOGIN ---
window.login = async ()=>{
  const email = document.getElementById("loginEmail").value;
  const password = document.getElementById("loginPassword").value;
  try{
    await signInWithEmailAndPassword(auth,email,password);
  }catch(err){ alert("Firebase error: "+err.message); }
}

// --- LOGOUT ---
document.getElementById("logoutBtn").addEventListener("click", async ()=>{
  await signOut(auth);
  location.reload();
});

// --- HAMBURGER MENU TOGGLE ---
const hamburger = document.getElementById("hamburgerIcon");
const sideMenu = document.getElementById("sideMenu");
hamburger.addEventListener("click", ()=>{
  if(sideMenu.style.left==="0px") sideMenu.style.left="-250px";
  else sideMenu.style.left="0px";
});

// --- AUTH STATE ---
onAuthStateChanged(auth,user=>{
  if(user){
    document.getElementById("signupDiv").style.display="none";
    document.getElementById("loginDiv").style.display="none";
    document.getElementById("gradesContainer").style.display="block";
    document.getElementById("memberInfoContainer").style.display="block";
    document.getElementById("hamburgerIcon").style.display="block";

    checkAdmin(user.email);
  } else {
    document.getElementById("signupDiv").style.display="block";
    document.getElementById("loginDiv").style.display="none";
    document.getElementById("gradesContainer").style.display="none";
    document.getElementById("adminPanel").style.display="none";
    document.getElementById("memberInfoContainer").style.display="none";
    document.getElementById("hamburgerIcon").style.display="none";
  }
});

// --- SHOW PANEL ---
function showPanel(id){
  const panels = ["gradesContainer","adminPanel","memberInfoContainer"];
  panels.forEach(p=>document.getElementById(p).style.display="none");
  document.getElementById(id).style.display="block";
}
  </script>

  <script type="module">
// --- CHECK IF ADMIN & LOAD DATA ---
async function checkAdmin(email){
  const usersRef = collection(db,"users");
  const q = query(usersRef, where("email","==",email));
  const snapshot = await getDocs(q);
  snapshot.forEach(docu=>{
    const data = docu.data();
    if(data.level==="admin"){
      document.getElementById("adminPanel").style.display="block";
      loadUsers();
      loadGradesAll();
    } else {
      document.getElementById("adminPanelButton").style.display="none";
      loadGrades(data.level,data.section);
      loadMemberInfo(data,email,docu.id);
    }
  });
}

// --- LOAD USERS ---
async function loadUsers(){
  const tbody = document.querySelector("#usersTable tbody");
  tbody.innerHTML="";
  const snapshot = await getDocs(collection(db,"users"));
  snapshot.forEach(doc=>{
    const data = doc.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${data.email}</td><td>${data.level}</td>
      <td>${data.section}</td>
      <td><input value="${data.section}" onchange="editSection('${doc.id}',this.value)"></td>
      <td><button onclick="deleteUser('${doc.id}')">Delete</button></td>`;
    tbody.appendChild(tr);
  });
}

// --- SEARCH USERS ---
document.getElementById("userSearch").addEventListener("input", ()=>{
  const val = document.getElementById("userSearch").value.toLowerCase();
  const rows = document.querySelectorAll("#usersTable tbody tr");
  rows.forEach(r=>{
    r.style.display = r.innerText.toLowerCase().includes(val)?"":"none";
  });
});

// --- EDIT SECTION ---
window.editSection = async (id,newSection)=>{
  await updateDoc(doc(db,"users",id),{section:newSection});
  alert("Section updated!");
  loadGradesAll();
}

// --- DELETE USER ---
window.deleteUser = async (id)=>{
  if(confirm("Are you sure you want to delete this user?")){
    await deleteDoc(doc(db,"users",id));
    loadUsers();
    loadGradesAll();
  }
}

// --- LOAD GRADES ---
async function loadGradesAll(){
  const tbody = document.querySelector("#gradesTable tbody");
  tbody.innerHTML="";
  const snapshot = await getDocs(collection(db,"grades"));
  snapshot.forEach(doc=>{
    const d=doc.data();
    const status = Number(d.grade)>=75?"<span class='passed'>Passed</span>":"<span class='failed'>Failed</span>";
    const tr = document.createElement("tr");
    tr.innerHTML=`<td>${d.student}</td><td>${d.level}</td><td>${d.section}</td><td>${d.subject}</td><td>${d.grade} ${status}</td>`;
    tbody.appendChild(tr);
  });
}

async function loadGrades(level,section){
  const tbody = document.querySelector("#gradesTable tbody");
  tbody.innerHTML="";
  const q = query(collection(db,"grades"),where("level","==",level),where("section","==",section));
  const snapshot = await getDocs(q);
  snapshot.forEach(doc=>{
    const d=doc.data();
    const status = Number(d.grade)>=75?"<span class='passed'>Passed</span>":"<span class='failed'>Failed</span>";
    const tr = document.createElement("tr");
    tr.innerHTML=`<td>${d.student}</td><td>${d.level}</td><td>${d.section}</td><td>${d.subject}</td><td>${d.grade} ${status}</td>`;
    tbody.appendChild(tr);
  });
}

// --- ADD / UPDATE GRADES ---
window.addOrUpdateGrade = async ()=>{
  const name = document.getElementById("studentName").value;
  const level = document.getElementById("studentLevel").value;
  const section = document.getElementById("studentSection").value;
  const subject = document.getElementById("studentSubject").value;
  const grade = document.getElementById("studentGrade").value;
  if(!name||!level||!section||!subject||!grade){ alert("Please fill all fields"); return; }

  const gradesRef = collection(db,"grades");
  const q = query(gradesRef, where("student","==",name), where("subject","==",subject), where("level","==",level), where("section","==",section));
  const snapshot = await getDocs(q);

  if(!snapshot.empty){
    snapshot.forEach(async docu=>{
      await updateDoc(doc(db,"grades",docu.id),{grade});
    });
    alert("Grade updated!");
  } else {
    await addDoc(gradesRef,{student:name,level,section,subject,grade});
    alert("Grade added!");
  }
  loadGradesAll();
}

// --- CREATE ADMIN ---
window.createAdmin = async ()=>{
  const email = document.getElementById("newAdminEmail").value;
  const password = document.getElementById("newAdminPassword").value;
  if(password.length<6){ alert("Password too short"); return; }
  try{
    await createUserWithEmailAndPassword(auth,email,password);
    await addDoc(collection(db,"users"),{email,level:"admin",section:""});
    alert("New admin created successfully!");
    document.getElementById("newAdminEmail").value="";
    document.getElementById("newAdminPassword").value="";
    document.getElementById("newAdminStrength").innerText="Password strength:";
    loadUsers();
  }catch(err){ alert("Firebase error: "+err.message); }
}

// --- LOAD MEMBER INFO ---
async function loadMemberInfo(data,userEmail,userId){
  const container = document.getElementById("memberInfoContainer");
  container.innerHTML = `
    <h2>My Information</h2>
    <input type="text" id="infoName" placeholder="Name" value="${data.name||''}">
    <input type="text" id="infoNumber" placeholder="Mobile Number" value="${data.number||''}">
    <input type="text" id="infoPurok" placeholder="Purok" value="${data.purok||''}">
    <input type="text" id="infoParents" placeholder="Parents/Guardian" value="${data.parents||''}">
    <input type="text" id="infoParentsNumber" placeholder="Parents Phone" value="${data.parentsNumber||''}">
    <button onclick="updateMemberInfo('${userId}')">Update Information</button>
  `;
}

window.updateMemberInfo = async (userId)=>{
  const name = document.getElementById("infoName").value;
  const number = document.getElementById("infoNumber").value;
  const purok = document.getElementById("infoPurok").value;
  const parents = document.getElementById("infoParents").value;
  const parentsNumber = document.getElementById("infoParentsNumber").value;
  await updateDoc(doc(db,"users",userId),{name,number,purok,parents,parentsNumber});
  alert("Information updated!");
}
</script>
</body>
</html>
