<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DANHS School Grades</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background-color:#f0f2f5; }
h1,h2,h3 { margin:10px 0; }
.container { padding:20px; max-width:1200px; margin:auto; }
input, select, button { display:block; margin:5px 0; padding:8px; }
button { cursor:pointer; }
table, th, td { border:1px solid #ccc; border-collapse:collapse; padding:8px; text-align:center; }
table { width:100%; margin-top:10px; overflow-x:auto; display:block; max-height:400px; overflow-y:auto; }
.passed { color:green; font-weight:bold; }
.failed { color:red; font-weight:bold; }
.strength { font-size:12px; color:red; }
#adminPanel, #gradesContainer, #logoutBtn, #hamburger, #menu { display:none; }
#menu { position:fixed; top:0; left:-250px; width:250px; height:100%; background:#333; color:#fff; transition:0.3s; padding:20px; z-index:1000; overflow-y:auto; }
#menu button { margin-top:5px; width:100%; }
#hamburger { position:fixed; top:10px; right:10px; font-size:30px; background:none; border:none; color:#333; z-index:1100; }
.zoom-btn { float:right; margin-bottom:5px; }
@media(max-width:768px){ table { font-size:12px; } }
</style>
</head>
<body>
<div class="container">

<h1>DANHS School Grades</h1>

<!-- Signup Form -->
<div id="signupDiv">
  <h2>Signup</h2>
  <input type="email" id="signupEmail" placeholder="Email">
  <input type="password" id="signupPassword" placeholder="Password">
  <button type="button" id="togglePassword">Show Password</button>
  <div class="strength" id="passwordStrength">Password strength: </div>
  <button id="signupBtn">Sign Up</button>
  <p>Already have an account? <button id="showLogin">Login</button></p>
</div>

<!-- Login Form -->
<div id="loginDiv">
  <h2>Login</h2>
  <input type="email" id="loginEmail" placeholder="Email">
  <input type="password" id="loginPassword" placeholder="Password">
  <button type="button" id="toggleLoginPassword">Show Password</button>
  <button id="loginBtn">Login</button>
</div>

<!-- Logout -->
<button id="logoutBtn">Logout</button>

<!-- Hamburger -->
<button id="hamburger">&#9776;</button>

<!-- Slide Menu -->
<div id="menu">
  <h3>Menu</h3>
  <button id="menuGradesBtn">Grades</button>
  <button id="menuUsersBtn">All Users</button>
  <button id="menuAddAdminBtn">Add Admin</button>
  <button id="closeMenu">&times; Close</button>
</div>

<!-- Main Content -->
<div id="mainContent">

  <!-- Admin Panel -->
  <div id="adminPanel">
    <h2>Admin Panel</h2>
    <div id="gradesSection">
      <h3>Grades <button class="zoom-btn" id="zoomGrades">üîç Zoom</button></h3>
      <input type="text" id="searchGrades" placeholder="Search student...">
      <table id="gradesTable">
        <thead>
          <tr><th>Student</th><th>Level</th><th>Section</th><th>Subject</th><th>Grade</th><th>Status</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <h3>Add / Update Grade</h3>
      <input type="text" id="studentName" placeholder="Student Name">
      <select id="studentLevel"><option value="">Select Level</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select>
      <select id="studentSection"><option value="">Select Section</option><option>A</option><option>B</option><option>C</option><option>D</option></select>
      <input type="text" id="studentSubject" placeholder="Subject">
      <input type="number" id="studentGrade" placeholder="Grade">
      <button id="addGradeBtn">Add / Update Grade</button>
    </div>

    <div id="usersSection">
      <h3>All Users</h3>
      <input type="text" id="searchUsers" placeholder="Search user...">
      <table id="usersTable">
        <thead><tr><th>Email</th><th>Level</th><th>Section</th><th>Edit Section</th><th>Delete</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="addAdminSection">
      <h3>Create New Admin</h3>
      <input type="email" id="newAdminEmail" placeholder="Admin Email">
      <input type="password" id="newAdminPassword" placeholder="Password">
      <button type="button" id="toggleNewAdminPassword">Show Password</button>
      <div class="strength" id="newAdminStrength">Password strength: </div>
      <button id="createAdminBtn">Create Admin</button>
    </div>
  </div>

  <!-- Student Grades -->
  <div id="gradesContainer">
    <h2>Grades <button class="zoom-btn" id="zoomGradesStudent">üîç Zoom</button></h2>
    <table id="gradesTableStudent">
      <thead><tr><th>Student</th><th>Level</th><th>Section</th><th>Subject</th><th>Grade</th><th>Status</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

// --- Firebase config ---
const firebaseConfig = {
  apiKey: "AIzaSyCYPONQgJC33Lp2OmMyKw4hssDStEwvPlQ",
  authDomain: "test-9c727.firebaseapp.com",
  projectId: "test-9c727",
  storageBucket: "test-9c727.firebasestorage.app",
  messagingSenderId: "198578631587",
  appId: "1:198578631587:web:c0831122f964d46149e016"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- Password toggle & strength ---
function setupPasswordToggle(inputId, toggleId, strengthId){
  const input = document.getElementById(inputId);
  const toggle = document.getElementById(toggleId);
  const strength = document.getElementById(strengthId);
  input.addEventListener("input", ()=>{ strength.innerText = input.value.length>=6?"Password strength: Strong":"Password strength: Weak"; });
  toggle.addEventListener("click", ()=>{ input.type = input.type==="password"?"text":"password"; });
}
setupPasswordToggle("signupPassword","togglePassword","passwordStrength");
setupPasswordToggle("loginPassword","toggleLoginPassword","passwordStrength");
setupPasswordToggle("newAdminPassword","toggleNewAdminPassword","newAdminStrength");

// --- Show login/signup toggle ---
document.getElementById("showLogin").addEventListener("click", ()=>{
  document.getElementById("signupDiv").style.display="none";
  document.getElementById("loginDiv").style.display="block";
});

// --- Signup ---
document.getElementById("signupBtn").addEventListener("click", async ()=>{
  const email = document.getElementById("signupEmail").value;
  const password = document.getElementById("signupPassword").value;
  if(password.length<6){ alert("Password too short"); return; }
  try{
    await createUserWithEmailAndPassword(auth,email,password);
    await addDoc(collection(db,"users"),{email,level:"7",section:"A"});
    alert("Signup successful! Ask admin to update level/section.");
  }catch(err){ alert("Firebase error: "+err.message); }
});

// --- Login ---
document.getElementById("loginBtn").addEventListener("click", async ()=>{
  const email = document.getElementById("loginEmail").value;
  const password = document.getElementById("loginPassword").value;
  try{ await signInWithEmailAndPassword(auth,email,password); }catch(err){ alert("Firebase error: "+err.message); }
});

// --- Logout ---
document.getElementById("logoutBtn").addEventListener("click", async ()=>{
  await auth.signOut(); location.reload();
});

// --- Hamburger menu ---
const hamburger = document.getElementById("hamburger");
const menu = document.getElementById("menu");
const closeMenu = document.getElementById("closeMenu");
hamburger.addEventListener("click", ()=>{ menu.style.left=menu.style.left==="0px"? "-250px":"0px"; });
closeMenu.addEventListener("click", ()=>{ menu.style.left="-250px"; });

// --- Zoom table ---
document.getElementById("zoomGrades").addEventListener("click", ()=>{ document.getElementById("gradesTable").style.width="200%"; });
document.getElementById("zoomGradesStudent").addEventListener("click", ()=>{ document.getElementById("gradesTableStudent").style.width="200%"; });

// --- Auth state listener ---
onAuthStateChanged(auth,user=>{
  if(user){
    document.getElementById("signupDiv").style.display="none";
    document.getElementById("loginDiv").style.display="none";
    document.getElementById("gradesContainer").style.display="block";
    document.getElementById("logoutBtn").style.display="block";
    document.getElementById("mainContent").style.display="block";
    hamburger.style.display="block";
    checkAdmin(user.email);
  }else{
    document.getElementById("signupDiv").style.display="block";
    document.getElementById("loginDiv").style.display="block";
    document.getElementById("gradesContainer").style.display="none";
    document.getElementById("adminPanel").style.display="none";
    document.getElementById("logoutBtn").style.display="none";
    document.getElementById("mainContent").style.display="none";
    hamburger.style.display="none";
    menu.style.left="-250px";
  }
});

// --- Check admin ---
async function checkAdmin(email){
  const usersRef = collection(db,"users");
  const q = query(usersRef, where("email","==",email));
  const snapshot = await getDocs(q);
  snapshot.forEach(docu=>{
    const data = docu.data();
    if(data.level==="admin"){
      document.getElementById("adminPanel").style.display="block";
      loadUsers();
      loadGradesAll();
    } else{
      loadGrades(data.level,data.section);
    }
  });
}

// --- Load users ---
async function loadUsers(){
  const tbody = document.querySelector("#usersTable tbody");
  tbody.innerHTML="";
  const snapshot = await getDocs(collection(db,"users"));
  snapshot.forEach(doc=>{
    const data = doc.data();
    const tr = document.createElement("tr");
    tr.innerHTML=`<td>${data.email}</td><td>${data.level}</td><td>${data.section}</td>
      <td><input value="${data.section}" onchange="editSection('${doc.id}',this.value)"></td>
      <td><button onclick="deleteUser('${doc.id}')">Delete</button></td>`;
    tbody.appendChild(tr);
  });
}

// --- Edit section ---
window.editSection = async (id, newSection) => {
  await updateDoc(doc(db, "users", id), { section: newSection });
  alert("Section updated!");
  loadUsers();
  loadGradesAll();
};

// --- Delete user ---
window.deleteUser = async (id) => {
  if (confirm("Are you sure you want to delete this user?")) {
    await deleteDoc(doc(db, "users", id));
    alert("User deleted!");
    loadUsers();
    loadGradesAll();
  }
};

// --- Load all grades (admin) ---
async function loadGradesAll() {
  const tbody = document.querySelector("#gradesTable tbody");
  tbody.innerHTML = "";
  const snapshot = await getDocs(collection(db, "grades"));
  snapshot.forEach(docu => {
    const d = docu.data();
    const status = d.grade >= 75 ? "Passed" : "Failed";
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${d.student}</td><td>${d.level}</td><td>${d.section}</td><td>${d.subject}</td>
                    <td>${d.grade}</td><td class="${status === 'Passed' ? 'passed' : 'failed'}">${status}</td>`;
    tbody.appendChild(tr);
  });
}

// --- Load grades for student ---
async function loadGrades(level, section) {
  const tbody = document.querySelector("#gradesTableStudent tbody");
  tbody.innerHTML = "";
  const q = query(collection(db, "grades"), where("level", "==", level), where("section", "==", section));
  const snapshot = await getDocs(q);
  snapshot.forEach(docu => {
    const d = docu.data();
    const status = d.grade >= 75 ? "Passed" : "Failed";
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${d.student}</td><td>${d.level}</td><td>${d.section}</td><td>${d.subject}</td>
                    <td>${d.grade}</td><td class="${status === 'Passed' ? 'passed' : 'failed'}">${status}</td>`;
    tbody.appendChild(tr);
  });
}

// --- Add or update grades ---
document.getElementById("addGradeBtn").addEventListener("click", async () => {
  const name = document.getElementById("studentName").value;
  const level = document.getElementById("studentLevel").value;
  const section = document.getElementById("studentSection").value;
  const subject = document.getElementById("studentSubject").value;
  const grade = Number(document.getElementById("studentGrade").value);

  if (!name || !level || !section || !subject || !grade) { alert("Fill all fields!"); return; }

  const gradesRef = collection(db, "grades");
  const q = query(gradesRef, where("student", "==", name), where("subject", "==", subject),
                  where("level", "==", level), where("section", "==", section));
  const snapshot = await getDocs(q);

  if (!snapshot.empty) {
    snapshot.forEach(async docu => {
      await updateDoc(doc(db, "grades", docu.id), { grade });
    });
    alert("Grade updated!");
  } else {
    await addDoc(gradesRef, { student: name, level, section, subject, grade });
    alert("Grade added!");
  }
  loadGradesAll();
});

// --- Create admin account ---
document.getElementById("createAdminBtn").addEventListener("click", async () => {
  const email = document.getElementById("newAdminEmail").value;
  const password = document.getElementById("newAdminPassword").value;
  if (password.length < 6) { alert("Password too short"); return; }
  try {
    await createUserWithEmailAndPassword(auth, email, password);
    await addDoc(collection(db, "users"), { email, level: "admin", section: "" });
    alert("New admin created!");
    document.getElementById("newAdminEmail").value = "";
    document.getElementById("newAdminPassword").value = "";
    loadUsers();
  } catch (err) { alert("Firebase error: " + err.message); }
});

// --- Search users ---
document.getElementById("searchUsers").addEventListener("input", () => {
  const filter = document.getElementById("searchUsers").value.toLowerCase();
  const rows = document.querySelectorAll("#usersTable tbody tr");
  rows.forEach(row => {
    row.style.display = row.textContent.toLowerCase().includes(filter) ? "" : "none";
  });
});

// --- Search grades ---
document.getElementById("searchGrades").addEventListener("input", () => {
  const filter = document.getElementById("searchGrades").value.toLowerCase();
  const rows = document.querySelectorAll("#gradesTable tbody tr");
  rows.forEach(row => {
    row.style.display = row.textContent.toLowerCase().includes(filter) ? "" : "none";
  });
});

// --- Menu buttons ---
document.getElementById("menuGradesBtn").addEventListener("click", () => {
  document.getElementById("gradesSection").style.display = "block";
  document.getElementById("usersSection").style.display = "none";
  document.getElementById("addAdminSection").style.display = "none";
});
document.getElementById("menuUsersBtn").addEventListener("click", () => {
  document.getElementById("gradesSection").style.display = "none";
  document.getElementById("usersSection").style.display = "block";
  document.getElementById("addAdminSection").style.display = "none";
});
document.getElementById("menuAddAdminBtn").addEventListener("click", () => {
  document.getElementById("gradesSection").style.display = "none";
  document.getElementById("usersSection").style.display = "none";
  document.getElementById("addAdminSection").style.display = "block";
});
</script>
</body>
</html>
