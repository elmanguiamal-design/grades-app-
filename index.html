<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DANHS School Grades</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f0f2f5; }
  h1,h2,h3 { margin:10px 0; }
  input, select, button { display:block; margin:5px 0; padding:8px; width:100%; box-sizing:border-box; }
  table { border-collapse: collapse; width: 100%; margin-top:10px; }
  table, th, td { border:1px solid black; padding:5px; text-align:left; }
  .passed { color:green; font-weight:bold; }
  .failed { color:red; font-weight:bold; }
  #adminPanel, #gradesContainer, #logoutBtn, #hamburgerIcon, #profilePanel { display:none; }
  #menu { position:fixed; left:-250px; top:0; width:250px; height:100%; background:#333; color:#fff; overflow:auto; transition:0.3s; padding:10px; z-index:999; }
  #menu button { margin-top:10px; width:100%; }
  #hamburgerIcon { position:fixed; top:10px; right:10px; font-size:30px; cursor:pointer; z-index:1000; display:none; }
  .zoomed { transform:scale(1.5); transform-origin:top left; }
  @media(max-width:768px){ #menu{width:200px;} }
</style>
</head>
<body>

<h1>DANHS School Grades</h1>

<!-- Signup -->
<div id="signupDiv">
  <h2>Sign Up</h2>
  <input type="email" id="signupEmail" placeholder="Email">
  <input type="password" id="signupPassword" placeholder="Password">
  <button type="button" id="togglePassword">Show Password</button>
  <div id="passwordStrength">Password strength:</div>
  <button onclick="signup()">Sign Up</button>
  <button onclick="showLogin()">Already have an account? Login</button>
</div>

<!-- Login -->
<div id="loginDiv" style="display:none;">
  <h2>Login</h2>
  <input type="email" id="loginEmail" placeholder="Email">
  <input type="password" id="loginPassword" placeholder="Password">
  <button type="button" id="toggleLoginPassword">Show Password</button>
  <button onclick="login()">Login</button>
  <button onclick="showSignup()">Don't have an account? Sign Up</button>
</div>

<!-- Logout & Hamburger -->
<div id="hamburgerIcon">&#9776;</div>

<!-- Side Menu -->
<div id="menu">
  <h3>Menu</h3>
  <button onclick="showPanel('gradesContainer')">Grades</button>
  <button onclick="showPanel('adminPanel')">Admin Panel</button>
  <button onclick="showPanel('profilePanel')">Profile</button>
  <button onclick="logout()">Logout</button>
</div>

<div id="mainContent">

  <!-- Grades Table -->
  <div id="gradesContainer">
    <h2>Grades</h2>
    <button id="zoomBtn">Zoom Table</button>
    <table id="gradesTable">
      <thead>
        <tr><th>Student</th><th>Level</th><th>Section</th><th>Subject</th><th>Grade</th><th>Status</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel">
    <h2>Admin Panel</h2>

    <!-- Search Users -->
    <h3>All Users</h3>
    <input type="text" id="searchUsers" placeholder="Search Users..." oninput="filterUsers()">
    <table id="usersTable">
      <thead>
        <tr><th>Email</th><th>Level</th><th>Section</th><th>Edit Section</th><th>Delete</th></tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Add/Edit Grades -->
    <h3>Add/Edit Grades</h3>
    <input type="text" id="studentName" placeholder="Student Name">
    <select id="studentLevel">
      <option value="">Level</option><option>7</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option>
    </select>
    <select id="studentSection">
      <option value="">Section</option><option>A</option><option>B</option><option>C</option><option>D</option>
    </select>
    <input type="text" id="studentSubject" placeholder="Subject">
    <input type="number" id="studentGrade" placeholder="Grade">
    <button onclick="addOrUpdateGrade()">Add/Update Grade</button>

    <!-- Create Admin -->
    <h3>Create Admin</h3>
    <input type="email" id="newAdminEmail" placeholder="Admin Email">
    <input type="password" id="newAdminPassword" placeholder="Password">
    <button type="button" id="toggleNewAdminPassword">Show Password</button>
    <div id="newAdminStrength">Password strength:</div>
    <button onclick="createAdmin()">Create Admin</button>
  </div>

  <!-- Profile Panel -->
  <div id="profilePanel">
    <h2>Profile</h2>
    <input type="text" id="profileName" placeholder="Name">
    <input type="text" id="profileNumber" placeholder="Mobile Number">
    <input type="text" id="profilePurok" placeholder="Purok">
    <input type="text" id="profileGuardian" placeholder="Parents/Guardian">
    <input type="text" id="profileGuardianNumber" placeholder="Guardian Phone Number">
    <button onclick="updateProfileInfo()">Update Profile</button>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

// --- Firebase Config ---
const firebaseConfig = {
  apiKey: "AIzaSyCYPONQgJC33Lp2OmMyKw4hssDStEwvPlQ",
  authDomain: "test-9c727.firebaseapp.com",
  projectId: "test-9c727",
  storageBucket: "test-9c727.firebasestorage.app",
  messagingSenderId: "198578631587",
  appId: "1:198578631587:web:c0831122f964d46149e016"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- Password Toggles ---
document.getElementById("togglePassword").addEventListener("click", ()=>toggleType("signupPassword"));
document.getElementById("toggleLoginPassword").addEventListener("click", ()=>toggleType("loginPassword"));
document.getElementById("toggleNewAdminPassword").addEventListener("click", ()=>toggleType("newAdminPassword"));
function toggleType(id){ const input=document.getElementById(id); input.type = input.type==="password"?"text":"password"; }

document.getElementById("signupPassword").addEventListener("input", ()=>{
  document.getElementById("passwordStrength").innerText = document.getElementById("signupPassword").value.length>=6?"Password strength: Strong":"Password strength: Weak";
});
document.getElementById("newAdminPassword").addEventListener("input", ()=>{
  document.getElementById("newAdminStrength").innerText = document.getElementById("newAdminPassword").value.length>=6?"Password strength: Strong":"Password strength: Weak";
});

// --- Show Login/Signup ---
function showLogin(){ document.getElementById("signupDiv").style.display="none"; document.getElementById("loginDiv").style.display="block"; }
function showSignup(){ document.getElementById("loginDiv").style.display="none"; document.getElementById("signupDiv").style.display="block"; }

// --- Signup/Login/Logout ---
async function signup(){
  const email=document.getElementById("signupEmail").value;
  const password=document.getElementById("signupPassword").value;
  if(password.length<6){ alert("Password too short"); return; }
  await createUserWithEmailAndPassword(auth,email,password);
  await addDoc(collection(db,"users"),{email,role:"student",level:"7",section:"A"});
  alert("Signup success!");
}

async function login(){
  const email=document.getElementById("loginEmail").value;
  const password=document.getElementById("loginPassword").value;
  try{ await signInWithEmailAndPassword(auth,email,password); } 
  catch(e){ alert("Login error: "+e.message); }
}

function logout(){ auth.signOut(); location.reload(); }

// --- Auth State ---
onAuthStateChanged(auth,user=>{
  if(user){
    document.getElementById("signupDiv").style.display="none";
    document.getElementById("loginDiv").style.display="none";
    document.getElementById("gradesContainer").style.display="block";
    document.getElementById("logoutBtn").style.display="block";
    document.getElementById("hamburgerIcon").style.display="block";
    loadGrades();
    loadUsers();
  } else {
    document.getElementById("signupDiv").style.display="block";
    document.getElementById("loginDiv").style.display="none";
    document.getElementById("gradesContainer").style.display="none";
    document.getElementById("adminPanel").style.display="none";
    document.getElementById("logoutBtn").style.display="none";
    document.getElementById("hamburgerIcon").style.display="none";
  }
});

// --- Hamburger Menu ---
const hamburger=document.getElementById("hamburgerIcon");
const menu=document.getElementById("menu");
hamburger.addEventListener("click", ()=>{
  menu.style.left = menu.style.left==="0px"? "-250px":"0px";
});

// --- Show Panels ---
function showPanel(id){
  document.getElementById("gradesContainer").style.display="none";
  document.getElementById("adminPanel").style.display="none";
  document.getElementById("profilePanel").style.display="none";
  document.getElementById(id).style.display="block";
}

// --- Zoom Table ---
document.getElementById("zoomBtn").addEventListener("click", ()=>{
  document.getElementById("gradesTable").classList.toggle("zoomed");
});

// --- Search Users ---
function filterUsers(){
  const filter = document.getElementById("searchUsers").value.toLowerCase();
  const rows = document.querySelectorAll("#usersTable tbody tr");
  rows.forEach(r=>{
    r.style.display = r.innerText.toLowerCase().includes(filter)?"":"none";
  });
}

// Remaining functions for add/update grades, create admin, delete users, profile update will be in part 3
      </script>

  <script type="module">
// --- Load Grades ---
async function loadGrades(){
  const gradesTableBody=document.querySelector("#gradesTable tbody");
  gradesTableBody.innerHTML="";
  const querySnapshot = await getDocs(collection(db,"grades"));
  querySnapshot.forEach(docSnap=>{
    const data = docSnap.data();
    const tr=document.createElement("tr");
    const status = data.grade>=75?"Passed":"Failed";
    const color = data.grade>=75?"green":"red";
    tr.innerHTML=`<td>${data.studentName}</td><td>${data.level}</td><td>${data.section}</td>
                  <td>${data.subject}</td><td style="color:${color}">${data.grade} (${status})</td>`;
    gradesTableBody.appendChild(tr);
  });
}

// --- Add or Update Grade ---
async function addOrUpdateGrade(){
  const name=document.getElementById("studentName").value;
  const level=document.getElementById("studentLevel").value;
  const section=document.getElementById("studentSection").value;
  const subject=document.getElementById("studentSubject").value;
  const grade=parseInt(document.getElementById("studentGrade").value);

  if(!name || !level || !section || !subject || isNaN(grade)){ alert("Please fill all fields"); return; }

  const q = query(collection(db,"grades"), where("studentName","==",name), where("subject","==",subject));
  const querySnapshot = await getDocs(q);
  if(!querySnapshot.empty){
    const docRef = querySnapshot.docs[0].ref;
    await updateDoc(docRef,{level,section,grade});
    alert("Grade updated!");
  } else {
    await addDoc(collection(db,"grades"),{studentName:name,level,section,subject,grade});
    alert("Grade added!");
  }
  loadGrades();
}

// --- Load Users ---
async function loadUsers(){
  const usersTableBody=document.querySelector("#usersTable tbody");
  usersTableBody.innerHTML="";
  const querySnapshot = await getDocs(collection(db,"users"));
  querySnapshot.forEach(docSnap=>{
    const data=docSnap.data();
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${data.email}</td><td>${data.level}</td><td>${data.section}</td>
                  <td><button onclick="editSection('${docSnap.id}')">Edit</button></td>
                  <td><button onclick="deleteUser('${docSnap.id}')">Delete</button></td>`;
    usersTableBody.appendChild(tr);
  });
}

// --- Edit Section ---
async function editSection(userId){
  const level=prompt("Enter new level:");
  const section=prompt("Enter new section:");
  if(level && section){
    await updateDoc(doc(db,"users",userId),{level,section});
    loadUsers();
  }
}

// --- Delete User ---
async function deleteUser(userId){
  if(confirm("Are you sure to delete this user?")){
    await deleteDoc(doc(db,"users",userId));
    loadUsers();
  }
}

// --- Create Admin ---
async function createAdmin(){
  const email=document.getElementById("newAdminEmail").value;
  const password=document.getElementById("newAdminPassword").value;
  if(password.length<6){ alert("Password too short"); return; }
  await createUserWithEmailAndPassword(auth,email,password);
  await addDoc(collection(db,"users"),{email,role:"admin"});
  alert("Admin created!");
  document.getElementById("newAdminEmail").value="";
  document.getElementById("newAdminPassword").value="";
}

// --- Update Profile ---
async function updateProfileInfo(){
  const user = auth.currentUser;
  if(!user) return;
  const profileData={
    name:document.getElementById("profileName").value,
    number:document.getElementById("profileNumber").value,
    purok:document.getElementById("profilePurok").value,
    guardian:document.getElementById("profileGuardian").value,
    guardianNumber:document.getElementById("profileGuardianNumber").value
  };
  const q = query(collection(db,"profiles"), where("email","==",user.email));
  const querySnapshot = await getDocs(q);
  if(!querySnapshot.empty){
    const docRef=querySnapshot.docs[0].ref;
    await updateDoc(docRef, profileData);
  } else {
    await addDoc(collection(db,"profiles"), {...profileData,email:user.email});
  }
  alert("Profile updated!");
}

// --- Check Admin Role ---
async function checkAdmin(email){
  const q=query(collection(db,"users"), where("email","==",email));
  const querySnapshot = await getDocs(q);
  if(!querySnapshot.empty){
    const data=querySnapshot.docs[0].data();
    if(data.role==="admin"){
      document.getElementById("adminPanel").style.display="block";
    }
  }
}
</script>
