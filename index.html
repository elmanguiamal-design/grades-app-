<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DANHS School Grades</title>
<style>
body { font-family: Arial; padding: 0; margin:0; background-color:#f2f2f2; }
header { position: fixed; width: 100%; top:0; background:#333; color:white; padding:10px; display:flex; justify-content:space-between; align-items:center; z-index:1000; }
#hamburger { font-size:24px; cursor:pointer; display:none; }
#menu { position: fixed; left:-250px; top:0; width:250px; height:100%; background:#444; color:white; padding:10px; transition:0.3s; overflow-y:auto; z-index:999; }
#menu a { color:white; display:block; padding:5px 0; text-decoration:none; }
#menu a:hover { background:#555; }
.container { padding:80px 20px 20px 20px; max-width:1200px; margin:auto; }
input, select, button { display:block; margin:5px 0; padding:8px; width:100%; max-width:300px; }
table, th, td { border: 1px solid black; border-collapse: collapse; padding: 5px; }
table { margin-top: 10px; width:100%; overflow-x:auto; display:block; max-height:400px; }
.passed { color:green; font-weight:bold; }
.failed { color:red; font-weight:bold; }
#signupDiv, #loginDiv { background:white; padding:20px; border-radius:8px; box-shadow:0 0 10px rgba(0,0,0,0.2); max-width:350px; margin:auto; margin-top:100px; }
#signupDiv { display:block; }
#loginDiv { display:none; }
#logoutBtn { display:none; padding:8px 12px; background:red; color:white; border:none; border-radius:5px; cursor:pointer; }
#gradesContainer, #adminPanel { display:none; }
.zoomIcon { cursor:pointer; font-size:18px; }
</style>
</head>
<body>

<header>
  <div>DANHS School</div>
  <div id="hamburger">&#9776;</div>
</header>

<div id="menu">
  <a href="#" id="closeMenu">Close</a>
  <div id="menuContent">
    <!-- Menu items dynamically added based on role -->
  </div>
</div>

<div class="container">

<!-- Signup Form -->
<div id="signupDiv">
  <h2>Signup</h2>
  <input type="email" id="signupEmail" placeholder="Email">
  <input type="password" id="signupPassword" placeholder="Password">
  <button type="button" id="togglePassword">Show Password</button>
  <div id="passwordStrength" style="color:red;font-size:12px;">Password strength: </div>
  <button onclick="signup()">Sign Up</button>
  <p>Already have an account? <a href="#" id="gotoLogin">Login</a></p>
</div>

<!-- Login Form -->
<div id="loginDiv">
  <h2>Login</h2>
  <input type="email" id="loginEmail" placeholder="Email">
  <input type="password" id="loginPassword" placeholder="Password">
  <button type="button" id="toggleLoginPassword">Show Password</button>
  <button onclick="login()">Login</button>
  <p>Don't have an account? <a href="#" id="gotoSignup">Signup</a></p>
</div>

<button id="logoutBtn">Logout</button>

<div id="mainContent">

  <!-- Part 2/3 -->

  <!-- Admin Panel -->
  <div id="adminPanel">
    <h2>Admin Panel</h2>

    <!-- Users Table with Search -->
    <h3>All Users</h3>
    <input type="text" id="searchUser" placeholder="Search users by email or name">
    <table id="usersTable">
      <thead>
        <tr>
          <th>Email</th>
          <th>Level</th>
          <th>Section</th>
          <th>Edit Section</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <!-- Add/Edit Grades -->
    <h3>Edit/Add Grades</h3>
    <input type="text" id="studentName" placeholder="Student Name">
    <select id="studentLevel">
      <option value="">Select Level</option>
      <option value="7">7</option><option value="8">8</option>
      <option value="9">9</option><option value="10">10</option>
      <option value="11">11</option><option value="12">12</option>
    </select>
    <select id="studentSection">
      <option value="">Select Section</option>
      <option value="A">A</option><option value="B">B</option>
      <option value="C">C</option><option value="D">D</option>
    </select>
    <input type="text" id="studentSubject" placeholder="Subject">
    <input type="number" id="studentGrade" placeholder="Grade">
    <button onclick="addOrUpdateGrade()">Add / Update Grade</button>

    <!-- Create New Admin -->
    <h3>Create New Admin</h3>
    <input type="email" id="newAdminEmail" placeholder="Admin Email">
    <input type="password" id="newAdminPassword" placeholder="Password">
    <button type="button" id="toggleNewAdminPassword">Show Password</button>
    <div id="newAdminStrength" style="color:red;font-size:12px;">Password strength: </div>
    <button onclick="createAdmin()">Create Admin</button>
  </div>

  <!-- Grades Table for Students -->
  <div id="gradesContainer">
    <h2>Grades <span class="zoomIcon" id="zoomGrades">&#128269;</span></h2>
    <table id="gradesTable">
      <thead>
        <tr>
          <th>Student</th>
          <th>Level</th>
          <th>Section</th>
          <th>Subject</th>
          <th>Grade</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, query, where, deleteDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

// --- Firebase config ---
const firebaseConfig = {
  apiKey: "AIzaSyCYPONQgJC33Lp2OmMyKw4hssDStEwvPlQ",
  authDomain: "test-9c727.firebaseapp.com",
  projectId: "test-9c727",
  storageBucket: "test-9c727.firebasestorage.app",
  messagingSenderId: "198578631587",
  appId: "1:198578631587:web:c0831122f964d46149e016"
};
// ----------------------------------------------
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- Password toggle & strength ---
const passwordInput = document.getElementById("signupPassword");
const strengthText = document.getElementById("passwordStrength");
passwordInput.addEventListener("input", ()=>{ strengthText.innerText = passwordInput.value.length>=6?"Password strength: Strong":"Password strength: Weak"; });
document.getElementById("togglePassword").addEventListener("click", ()=>{ passwordInput.type=passwordInput.type==="password"?"text":"password"; });

const loginPass = document.getElementById("loginPassword");
document.getElementById("toggleLoginPassword").addEventListener("click", ()=>{ loginPass.type = loginPass.type==="password"?"text":"password"; });

const newAdminPass = document.getElementById("newAdminPassword");
const newAdminStrength = document.getElementById("newAdminStrength");
newAdminPass.addEventListener("input", ()=>{ newAdminStrength.innerText=newAdminPass.value.length>=6?"Password strength: Strong":"Password strength: Weak"; });
document.getElementById("toggleNewAdminPassword").addEventListener("click", ()=>{ newAdminPass.type=newAdminPass.type==="password"?"text":"password"; });

// --- Login/Signup toggle ---
document.getElementById("gotoLogin").onclick = ()=>{
  document.getElementById("signupDiv").style.display="none";
  document.getElementById("loginDiv").style.display="block";
};
document.getElementById("gotoSignup").onclick = ()=>{
  document.getElementById("loginDiv").style.display="none";
  document.getElementById("signupDiv").style.display="block";
};

// --- Signup ---
window.signup = async ()=>{
  const email = document.getElementById("signupEmail").value;
  const password = passwordInput.value;
  if(password.length<6){ alert("Password too short"); return; }
  try{
    await createUserWithEmailAndPassword(auth,email,password);
    await addDoc(collection(db,"users"),{email, level:"7", section:"A"}); // default student
    alert("Signup successful! Ask admin to update level/section.");
  }catch(err){ alert("Firebase error: "+err.message); }
}

// --- Login ---
window.login = async ()=>{
  const email = document.getElementById("loginEmail").value;
  const password = document.getElementById("loginPassword").value;
  try{
    await signInWithEmailAndPassword(auth,email,password);
  }catch(err){ alert("Firebase error: "+err.message); }
}

// --- Logout ---
document.getElementById("logoutBtn").addEventListener("click", async ()=>{
  await auth.signOut();
  location.reload();
});

  <!-- Part 3/3 -->

<script type="module">

// --- Hamburger menu ---
const hamburger = document.getElementById("hamburger");
const menu = document.getElementById("menu");
const closeMenu = document.getElementById("closeMenu");

hamburger.addEventListener("click", ()=>{
  if(menu.style.left==="0px"){ menu.style.left="-250px"; }
  else{ menu.style.left="0px"; }
});
closeMenu.addEventListener("click", ()=>{ menu.style.left="-250px"; });

// --- Zoom-in grades table ---
document.getElementById("zoomGrades").addEventListener("click", ()=>{
  const table = document.getElementById("gradesTable");
  table.style.width = table.style.width==="100%"?"200%":"100%";
});

// --- Auth state listener ---
onAuthStateChanged(auth,user=>{
  if(user){
    document.getElementById("signupDiv").style.display="none";
    document.getElementById("loginDiv").style.display="none";
    document.getElementById("gradesContainer").style.display="block";
    document.getElementById("logoutBtn").style.display="block";
    document.getElementById("mainContent").style.display="block";
    hamburger.style.display="block";
    checkAdmin(user.email);
  } else{
    document.getElementById("signupDiv").style.display="block";
    document.getElementById("loginDiv").style.display="block";
    document.getElementById("gradesContainer").style.display="none";
    document.getElementById("adminPanel").style.display="none";
    document.getElementById("logoutBtn").style.display="none";
    document.getElementById("mainContent").style.display="none";
    hamburger.style.display="none";
    menu.style.left="-250px";
  }
});

// --- Check admin & load content ---
async function checkAdmin(email){
  const usersRef = collection(db,"users");
  const q = query(usersRef, where("email","==",email));
  const snapshot = await getDocs(q);
  snapshot.forEach(docu=>{
    const data = docu.data();
    if(data.level==="admin"){
      document.getElementById("adminPanel").style.display="block";
      loadUsers();
      loadGradesAll();
    } else{
      loadGrades(data.level,data.section);
    }
  });
}

// --- Load users ---
async function loadUsers(){
  const tbody = document.querySelector("#usersTable tbody");
  tbody.innerHTML="";
  const snapshot = await getDocs(collection(db,"users"));
  snapshot.forEach(doc=>{
    const data = doc.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${data.email}</td><td>${data.level}</td><td>${data.section}</td>
      <td><input value="${data.section}" onchange="editSection('${doc.id}',this.value)"></td>
      <td><button onclick="deleteUser('${doc.id}')">Delete</button></td>`;
    tbody.appendChild(tr);
  });
}

// --- Edit section ---
window.editSection = async (id,newSection)=>{
  await updateDoc(doc(db,"users",id),{section:newSection});
  alert("Section updated!");
  loadGradesAll();
}

// --- Delete user ---
window.deleteUser = async (id)=>{
  if(confirm("Are you sure you want to delete this user?")){
    await deleteDoc(doc(db,"users",id));
    alert("User deleted!");
    loadUsers();
  }
}

// --- Load grades ---
async function loadGradesAll(){
  const tbody = document.querySelector("#gradesTable tbody");
  tbody.innerHTML="";
  const snapshot = await getDocs(collection(db,"grades"));
  snapshot.forEach(doc=>{
    const d=doc.data();
    const status = d.grade>=75?'<span class="passed">Passed</span>':'<span class="failed">Failed</span>';
    const tr = document.createElement("tr");
    tr.innerHTML=`<td>${d.student}</td><td>${d.level}</td><td>${d.section}</td>
      <td>${d.subject}</td><td>${d.grade}</td><td>${status}</td>`;
    tbody.appendChild(tr);
  });
}

async function loadGrades(level,section){
  const tbody = document.querySelector("#gradesTable tbody");
  tbody.innerHTML="";
  const q = query(collection(db,"grades"),where("level","==",level),where("section","==",section));
  const snapshot = await getDocs(q);
  snapshot.forEach(doc=>{
    const d=doc.data();
    const status = d.grade>=75?'<span class="passed">Passed</span>':'<span class="failed">Failed</span>';
    const tr = document.createElement("tr");
    tr.innerHTML=`<td>${d.student}</td><td>${d.level}</td><td>${d.section}</td>
      <td>${d.subject}</td><td>${d.grade}</td><td>${status}</td>`;
    tbody.appendChild(tr);
  });
}

// --- Add or update grades ---
window.addOrUpdateGrade = async ()=>{
  const name = document.getElementById("studentName").value;
  const level = document.getElementById("studentLevel").value;
  const section = document.getElementById("studentSection").value;
  const subject = document.getElementById("studentSubject").value;
  const grade = document.getElementById("studentGrade").value;

  const gradesRef = collection(db,"grades");
  const q = query(gradesRef, where("student","==",name), where("subject","==",subject), where("level","==",level), where("section","==",section));
  const snapshot = await getDocs(q);

  if(!snapshot.empty){
    snapshot.forEach(async docu=>{
      await updateDoc(doc(db,"grades",docu.id),{grade});
    });
    alert("Grade updated!");
  } else {
    await addDoc(gradesRef,{student:name,level,section,subject,grade});
    alert("Grade added!");
  }

  loadGradesAll();
}

// --- Create admin ---
window.createAdmin = async ()=>{
  const email = document.getElementById("newAdminEmail").value;
  const password = newAdminPass.value;
  if(password.length<6){ alert("Password too short"); return; }
  try{
    await createUserWithEmailAndPassword(auth,email,password);
    await addDoc(collection(db,"users"),{email,level:"admin",section:""});
    alert("New admin created successfully!");
    document.getElementById("newAdminEmail").value="";
    newAdminPass.value="";
    newAdminStrength.innerText="Password strength:";
    loadUsers();
  }catch(err){ alert("Firebase error: "+err.message); }
}
</script>
</body>
</html>
