<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DANHS School Grades</title>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; }
header { background:#2c3e50; color:white; padding:10px; position:relative; }
header h1 { margin:0; }
#hamburger { display:none; position:absolute; top:10px; right:10px; font-size:24px; cursor:pointer; z-index:1100; }
#sideMenu { display:none; position:fixed; top:0; left:0; width:250px; height:100%; background:#ecf0f1; padding:20px; box-shadow:2px 0 5px rgba(0,0,0,0.3); z-index:1000; }
#sideMenu button, #sideMenu a { display:block; width:100%; padding:10px; margin:5px 0; background:#3498db; color:white; border:none; text-align:left; cursor:pointer; border-radius:5px; }
#sideMenu button:hover, #sideMenu a:hover { background:#2980b9; }
.container { padding:20px; }
input, select, button { padding:8px; margin:5px 0; width:100%; max-width:400px; display:block; }
table { width:100%; border-collapse:collapse; margin-top:15px; }
table, th, td { border:1px solid #333; }
th, td { padding:8px; text-align:center; }
.strength { font-size:12px; color:red; }
.scrollPanel { max-height:400px; overflow-y:auto; margin-top:10px; border:1px solid #ccc; padding:5px; border-radius:5px; }
.zoomBtn { float:right; cursor:pointer; font-size:18px; margin-bottom:5px; background:none; border:none; }
@media(max-width:600px) { header h1{font-size:18px;} table, th, td{font-size:12px;} }
</style>
</head>
<body>

<header>
  <h1>DANHS School Grades</h1>
  <div id="hamburger" onclick="toggleMenu()">‚ò∞</div>
</header>

<!-- Side Menu -->
<div id="sideMenu">
  <button onclick="showPanel('gradesContainer')">üìñ Grades</button>
  <button onclick="showPanel('adminPanel')">‚öôÔ∏è Admin Panel</button>
  <button onclick="showPanel('infoPanel')">üë§ My Information</button>
  <button id="logoutBtn">üö™ Logout</button>
</div>

<div class="container">

  <!-- Signup Form -->
  <div id="signupDiv">
    <h2>Signup</h2>
    <input type="text" id="signupName" placeholder="Full Name">
    <input type="email" id="signupEmail" placeholder="Email">
    <input type="password" id="signupPassword" placeholder="Password">
    <button type="button" id="togglePassword">Show Password</button>
    <div class="strength" id="passwordStrength">Password strength: </div>
    <button onclick="signup()">Sign Up</button>
    <p>Already have an account? <a href="#" onclick="toggleForms()">Login</a></p>
  </div>

  <!-- Login Form -->
  <div id="loginDiv" style="display:none;">
    <h2>Login</h2>
    <input type="email" id="loginEmail" placeholder="Email">
    <input type="password" id="loginPassword" placeholder="Password">
    <button type="button" id="toggleLoginPassword">Show Password</button>
    <button onclick="login()">Login</button>
    <p>Don't have an account? <a href="#" onclick="toggleForms()">Sign Up</a></p>
  </div>

  <!-- Admin Panel -->
  <div id="adminPanel" style="display:none;">
    <h2>Admin Panel 
      <button class="zoomBtn" onclick="zoomPanel('adminPanel')">üîç</button>
    </h2>

    <input type="text" id="searchUsers" placeholder="Search members..." onkeyup="searchUsers()">
    <div class="scrollPanel" id="usersScroll">
      <h3>All Users</h3>
      <table id="usersTable">
        <thead>
          <tr><th>Email</th><th>Name</th><th>Level</th><th>Section</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <h3>Add / Update Grades <button class="zoomBtn" onclick="zoomPanel('gradesContainer')">üîç</button></h3>
    <input type="text" id="studentName" placeholder="Student Name">
    <select id="studentLevel">
      <option value="">Select Level</option>
      <option value="7">7</option><option value="8">8</option>
      <option value="9">9</option><option value="10">10</option>
      <option value="11">11</option>
      <option value="12">12</option>
    </select>
    <select id="studentSection">
      <option value="">Select Section</option>
      <option value="A">A</option><option value="B">B</option>
      <option value="C">C</option>
      <option value="D">D</option>
    </select>
    <input type="text" id="studentSubject" placeholder="Subject">
    <input type="number" id="studentGrade" placeholder="Grade">
    <button onclick="addOrUpdateGrade()">Add / Update Grade</button>

    <h3>Create Admin <button class="zoomBtn" onclick="zoomPanel('adminPanel')">üîç</button></h3>
    <input type="email" id="newAdminEmail" placeholder="Admin Email">
    <input type="password" id="newAdminPassword" placeholder="Password">
    <button type="button" id="toggleNewAdminPassword">Show Password</button>
    <div class="strength" id="newAdminStrength">Password strength: </div>
    <button onclick="createAdmin()">Create Admin</button>
  </div>

  <!-- Grades Table -->
  <div id="gradesContainer" style="display:none;">
    <h2>Grades <button class="zoomBtn" onclick="zoomPanel('gradesContainer')">üîç</button></h2>
    <div class="scrollPanel" id="gradesScroll">
      <table id="gradesTable">
        <thead>
          <tr><th>Student</th><th>Level</th><th>Section</th><th>Subject</th><th>Grade</th><th>Remarks</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Info Panel -->
  <div id="infoPanel" style="display:none;">
    <h2>My Information <button class="zoomBtn" onclick="zoomPanel('infoPanel')">üîç</button></h2>
    <div class="scrollPanel" id="infoScroll">
      <input type="text" id="infoName" placeholder="Name">
      <input type="text" id="infoNumber" placeholder="Mobile Number">
      <input type="text" id="infoPurok" placeholder="Purok">
      <input type="text" id="infoGuardian" placeholder="Parent/Guardian">
      <input type="text" id="infoGuardianPhone" placeholder="Guardian Phone">
      <button onclick="saveInfo()">Save Info</button>
    </div>
  </div>

<script type="module">

  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

// --- Firebase config ---
const firebaseConfig = {
  apiKey: "AIzaSyCYPONQgJC33Lp2OmMyKw4hssDStEwvPlQ",
  authDomain: "test-9c727.firebaseapp.com",
  projectId: "test-9c727",
  storageBucket: "test-9c727.firebasestorage.app",
  messagingSenderId: "198578631587",
  appId: "1:198578631587:web:c0831122f964d46149e016"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- Hamburger toggle ---
window.toggleMenu = ()=>{
  const menu = document.getElementById("sideMenu");
  menu.style.display = (menu.style.display==="block")?"none":"block";
};

// --- Separate login/signup ---
window.toggleForms = ()=>{
  const login = document.getElementById("loginDiv");
  const signup = document.getElementById("signupDiv");
  if(login.style.display==="none"){ login.style.display="block"; signup.style.display="none"; }
  else{ login.style.display="none"; signup.style.display="block"; }
};

// --- Show panels ---
window.showPanel = (panelId)=>{
  const panels=["gradesContainer","adminPanel","infoPanel"];
  panels.forEach(p=>{ document.getElementById(p).style.display=(p===panelId)?"block":"none"; });
  document.getElementById("sideMenu").style.display="none"; // close menu after click
};

// --- Zoom panel ---
window.zoomPanel = (panelId)=>{
  const panel = document.getElementById(panelId);
  if(panel.style.position==="fixed"){
    panel.style.position=""; panel.style.top=""; panel.style.left=""; panel.style.width=""; panel.style.height=""; panel.style.background=""; panel.style.zIndex="";
  } else {
    panel.style.position="fixed"; panel.style.top="0"; panel.style.left="0"; panel.style.width="100%"; panel.style.height="100%"; panel.style.background="#fff"; panel.style.zIndex="1200";
  }
};

// --- Signup ---
window.signup = async ()=>{
  const email = document.getElementById("signupEmail").value;
  const password = document.getElementById("signupPassword").value;
  const name = document.getElementById("signupName").value;
  if(password.length<6){ alert("Password too short"); return; }
  try{
    await createUserWithEmailAndPassword(auth,email,password);
    await addDoc(collection(db,"users"),{email,name,level:"7",section:"A"});
    alert("Signup successful!"); toggleForms();
  }catch(err){ alert("Error: "+err.message); }
};

// --- Login ---
window.login = async ()=>{
  const email = document.getElementById("loginEmail").value;
  const password = document.getElementById("loginPassword").value;
  try{ await signInWithEmailAndPassword(auth,email,password); } 
  catch(err){ alert("Error: "+err.message); }
};

// --- Logout ---
document.getElementById("logoutBtn").addEventListener("click", async ()=>{
  await signOut(auth);
  location.reload();
});

// --- Auth listener ---
onAuthStateChanged(auth,user=>{
  const hamburger = document.getElementById("hamburger");
  if(user){ hamburger.style.display="block"; checkAdmin(user.uid); }
  else{ hamburger.style.display="none"; document.getElementById("signupDiv").style.display="block"; document.getElementById("loginDiv").style.display="none"; document.getElementById("adminPanel").style.display="none"; document.getElementById("gradesContainer").style.display="none"; document.getElementById("infoPanel").style.display="none"; }
});

// --- Check admin ---
async function checkAdmin(uid){
  const q = query(collection(db,"users"),where("email","==",auth.currentUser.email));
  const snap = await getDocs(q);
  let isAdmin=false;
  snap.forEach(docu=>{ if(docu.data().level==="admin"){ isAdmin=true; } });
  if(isAdmin){ document.getElementById("adminPanel").style.display="block"; loadUsers(); loadGradesAll(); showPanel("gradesContainer"); }
  else{ showPanel("gradesContainer"); loadGradesStudent(auth.currentUser.email); loadInfoStudent(auth.currentUser.email); }
}

// --- Load users ---
async function loadUsers(){
  const tbody = document.querySelector("#usersTable tbody"); tbody.innerHTML="";
  const snap = await getDocs(collection(db,"users"));
  snap.forEach(doc=>{
    const d = doc.data();
    const tr = document.createElement("tr");
    tr.innerHTML=`<td>${d.email}</td><td>${d.name||""}</td><td>${d.level||""}</td><td>${d.section||""}</td>
      <td><button onclick="deleteUser('${doc.id}')">Delete</button></td>`;
    tbody.appendChild(tr);
  });
}

// --- Search users ---
window.searchUsers = ()=>{
  const input = document.getElementById("searchUsers").value.toLowerCase();
  const rows = document.querySelectorAll("#usersTable tbody tr");
  rows.forEach(r=>{
    const text = r.innerText.toLowerCase();
    r.style.display = text.includes(input) ? "" : "none";
  });
};

// --- Delete user ---
window.deleteUser = async (id)=>{
  if(confirm("Are you sure you want to delete this user?")){
    await deleteDoc(doc(db,"users",id));
    loadUsers(); loadGradesAll();
  }
};

// --- Load grades (admin) ---
async function loadGradesAll(){
  const tbody = document.querySelector("#gradesTable tbody"); tbody.innerHTML="";
  const snap = await getDocs(collection(db,"grades"));
  snap.forEach(doc=>{
    const d = doc.data();
    const remarks = d.grade>=75?"Passed":"Failed";
    const tr = document.createElement("tr");
    tr.innerHTML=`<td>${d.student}</td><td>${d.level}</td><td>${d.section}</td><td>${d.subject}</td><td>${d.grade}</td><td>${remarks}</td>`;
    tbody.appendChild(tr);
  });
}

// --- Load student grades ---
async function loadGradesStudent(email){
  const tbody = document.querySelector("#gradesTable tbody"); tbody.innerHTML="";
  const q = query(collection(db,"users"),where("email","==",email));
  const snap = await getDocs(q);
  snap.forEach(async docu=>{
    const data = docu.data();
    const gradesQ = query(collection(db,"grades"),where("level","==",data.level),where("section","==",data.section));
    const gradesSnap = await getDocs(gradesQ);
    gradesSnap.forEach(doc=>{
      const d = doc.data();
      const remarks = d.grade>=75?"Passed":"Failed";
      const tr = document.createElement("tr");
      tr.innerHTML=`<td>${d.student}</td><td>${d.level}</td><td>${d.section}</td><td>${d.subject}</td><td>${d.grade}</td><td>${remarks}</td>`;
      tbody.appendChild(tr);
    });
  });
}

// --- Add or update grade ---
window.addOrUpdateGrade = async ()=>{
  const name = document.getElementById("studentName").value;
  const level = document.getElementById("studentLevel").value;
  const section = document.getElementById("studentSection").value;
  const subject = document.getElementById("studentSubject").value;
  const grade = parseFloat(document.getElementById("studentGrade").value);
  if(!name||!level||!section||!subject||isNaN(grade)){ alert("Fill all fields"); return; }

  const gradesRef = collection(db,"grades");
  const q = query(gradesRef, where("student","==",name), where("subject","==",subject), where("level","==",level), where("section","==",section));
  const snapshot = await getDocs(q);
  if(!snapshot.empty){ snapshot.forEach(async docu=>{ await updateDoc(doc(db,"grades",docu.id),{grade}); }); alert("Grade updated!"); }
  else{ await addDoc(gradesRef,{student:name,level,section,subject,grade}); alert("Grade added!"); }
  loadGradesAll();
};

  // --- Create admin ---
window.createAdmin = async ()=>{
  const email = document.getElementById("newAdminEmail").value;
  const password = document.getElementById("newAdminPassword").value;
  if(password.length<6){ alert("Password too short"); return; }
  try{
    await createUserWithEmailAndPassword(auth,email,password);
    await addDoc(collection(db,"users"),{email,level:"admin",section:"",name:"Admin"});
    alert("New admin created!");
    document.getElementById("newAdminEmail").value=""; 
    document.getElementById("newAdminPassword").value=""; 
    document.getElementById("newAdminStrength").innerText="Password strength:";
    loadUsers();
  }catch(err){ alert("Error: "+err.message); }
};

// --- Load student info for My Information panel ---
async function loadInfoStudent(email){
  const q = query(collection(db,"users"),where("email","==",email));
  const snap = await getDocs(q);
  snap.forEach(docu=>{
    const d = docu.data();
    document.getElementById("infoName").value = d.name||"";
    document.getElementById("infoNumber").value = d.number||"";
    document.getElementById("infoPurok").value = d.purok||"";
    document.getElementById("infoGuardian").value = d.guardian||"";
    document.getElementById("infoGuardianPhone").value = d.guardianPhone||"";
  });
}

// --- Save student info ---
window.saveInfo = async ()=>{
  const name = document.getElementById("infoName").value;
  const number = document.getElementById("infoNumber").value;
  const purok = document.getElementById("infoPurok").value;
  const guardian = document.getElementById("infoGuardian").value;
  const guardianPhone = document.getElementById("infoGuardianPhone").value;

  const q = query(collection(db,"users"),where("email","==",auth.currentUser.email));
  const snap = await getDocs(q);
  snap.forEach(async docu=>{
    await updateDoc(doc(db,"users",docu.id),{
      name, number, purok, guardian, guardianPhone
    });
  });
  alert("Information saved!");
  loadInfoStudent(auth.currentUser.email);
};

  // --- Hamburger menu hidden until login ---
document.getElementById("hamburger").style.display="none";

// --- Toggle password visibility ---
document.getElementById("togglePassword").addEventListener("click", ()=>{
  const pass = document.getElementById("signupPassword");
  pass.type = pass.type==="password"?"text":"password";
});
document.getElementById("toggleLoginPassword").addEventListener("click", ()=>{
  const pass = document.getElementById("loginPassword");
  pass.type = pass.type==="password"?"text":"password";
});
document.getElementById("toggleNewAdminPassword").addEventListener("click", ()=>{
  const pass = document.getElementById("newAdminPassword");
  pass.type = pass.type==="password"?"text":"password";
});

// --- Password strength ---
document.getElementById("signupPassword").addEventListener("input", ()=>{
  document.getElementById("passwordStrength").innerText = document.getElementById("signupPassword").value.length>=6?"Password strength: Strong":"Password strength: Weak";
});
document.getElementById("newAdminPassword").addEventListener("input", ()=>{
  document.getElementById("newAdminStrength").innerText = document.getElementById("newAdminPassword").value.length>=6?"Password strength: Strong":"Password strength: Weak";
});

// --- Scrollbars for panels ---
const panels = ["gradesContainer","adminPanel","infoPanel"];
panels.forEach(p=>{
  const el = document.getElementById(p);
  el.style.overflowY = "auto";
  el.style.maxHeight = "80vh";
});

// --- Zoom buttons for all panels ---
document.querySelectorAll(".zoomBtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const panelId = btn.getAttribute("data-panel");
    zoomPanel(panelId);
  });
});

// --- Ensure logout goes back to login/signup ---
onAuthStateChanged(auth,user=>{
  if(!user){
    showPanel(""); // hide all panels
    document.getElementById("loginDiv").style.display="block";
    document.getElementById("signupDiv").style.display="block";
  }
});

// --- Ensure mobile responsiveness (optional simple style) ---
document.querySelectorAll("table").forEach(tbl=>{
  tbl.style.width="100%";
  tbl.style.tableLayout="fixed";
  tbl.style.wordWrap="break-word";
});

// --- Close script & body in HTML ---
</script>
</body>
</html>
