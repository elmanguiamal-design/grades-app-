<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DANHS School Grades</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    input, button { display: block; margin: 5px 0; padding: 8px; }
    table, th, td { border: 1px solid black; border-collapse: collapse; padding: 5px; }
    table { margin-top: 10px; }
  </style>
</head>
<body>

<h1>DANHS School Grades</h1>

<!-- Signup Form -->
<div id="signupDiv">
  <h2>Signup</h2>
  <input type="email" id="signupEmail" placeholder="Email">
  <input type="password" id="signupPassword" placeholder="Password">
  <button onclick="signup()">Sign Up</button>
</div>

<!-- Login Form -->
<div id="loginDiv">
  <h2>Login</h2>
  <input type="email" id="loginEmail" placeholder="Email">
  <input type="password" id="loginPassword" placeholder="Password">
  <button onclick="login()">Login</button>
</div>

<hr>

<!-- Main Content (hidden until login) -->
<div id="mainContent" style="display:none;">

  <!-- Admin Panel -->
  <div id="adminPanel" style="display:none;">
    <h2>Admin Panel</h2>
    <input type="text" id="studentName" placeholder="Student Name">
    <input type="text" id="studentLevel" placeholder="Level">
    <input type="text" id="studentSection" placeholder="Section">
    <input type="text" id="studentSubject" placeholder="Subject">
    <input type="number" id="studentGrade" placeholder="Grade">
    <button onclick="addGrade()">Add / Update Grade</button>
  </div>

  <!-- Grades Table -->
  <div id="gradesContainer">
    <h2>Grades</h2>
    <table id="gradesTable">
      <thead>
        <tr>
          <th>Student</th>
          <th>Level</th>
          <th>Section</th>
          <th>Subject</th>
          <th>Grade</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import { getFirestore, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

// --- Firebase config ---
const firebaseConfig = {
  apiKey: "AIzaSyCYPONQgJC33Lp2OmMyKw4hssDStEwvPlQ",
  authDomain: "test-9c727.firebaseapp.com",
  projectId: "test-9c727",
  storageBucket: "test-9c727.firebasestorage.app",
  messagingSenderId: "198578631587",
  appId: "1:198578631587:web:c0831122f964d46149e016"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- Signup ---
window.signup = () => {
  const email = document.getElementById("signupEmail").value;
  const password = document.getElementById("signupPassword").value;
  createUserWithEmailAndPassword(auth, email, password)
    .then(() => {
      alert("Signup successful");
      document.getElementById("signupDiv").style.display = "none";
      document.getElementById("loginDiv").style.display = "none";
    })
    .catch(err => alert(err.message));
}

// --- Login ---
window.login = () => {
  const email = document.getElementById("loginEmail").value;
  const password = document.getElementById("loginPassword").value;
  signInWithEmailAndPassword(auth, email, password)
    .then(() => {
      alert("Login successful");
      document.getElementById("signupDiv").style.display = "none";
      document.getElementById("loginDiv").style.display = "none";
    })
    .catch(err => alert(err.message));
}

// --- Show main content only after login ---
onAuthStateChanged(auth, user => {
  if(user){
    document.getElementById("mainContent").style.display = "block";

    const usersRef = collection(db, "users");
    const q = query(usersRef, where("email", "==", user.email));
    getDocs(q).then(snapshot => {
      snapshot.forEach(doc => {
        const data = doc.data();
        if(data.level === "admin"){
          document.getElementById("adminPanel").style.display = "block";
        }
        loadGrades(data.level, data.section); // student sees only their section
      });
    });

    // Hide login/signup forms
    document.getElementById("signupDiv").style.display = "none";
    document.getElementById("loginDiv").style.display = "none";

  } else {
    // logged out â†’ hide everything
    document.getElementById("mainContent").style.display = "none";
    document.getElementById("adminPanel").style.display = "none";
    document.getElementById("signupDiv").style.display = "block";
    document.getElementById("loginDiv").style.display = "block";
  }
});

// --- Add/Update Grade (Admin only) ---
window.addGrade = async () => {
  const name = document.getElementById("studentName").value;
  const level = document.getElementById("studentLevel").value;
  const section = document.getElementById("studentSection").value;
  const subject = document.getElementById("studentSubject").value;
  const grade = document.getElementById("studentGrade").value;

  await addDoc(collection(db, "grades"), { student:name, level, section, subject, grade });
  alert("Grade added!");
  loadGrades(level, section);
}

// --- Load Grades for current user ---
async function loadGrades(userLevel, userSection){
  const gradesTable = document.querySelector("#gradesTable tbody");
  gradesTable.innerHTML = "";
  const gradesRef = collection(db, "grades");
  const q = query(gradesRef, where("level", "==", userLevel), where("section", "==", userSection));
  const snapshot = await getDocs(q);
  snapshot.forEach(doc => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${doc.data().student}</td><td>${doc.data().level}</td><td>${doc.data().section}</td><td>${doc.data().subject}</td><td>${doc.data().grade}</td>`;
    gradesTable.appendChild(tr);
  });
}
</script>

</body>
</html>
